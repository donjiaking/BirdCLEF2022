# 1st Place Winning Solution - BirdCLEF 2021 - Birdcall Identification

Below is our solution for the [BirdCLEF 2021 - Birdcall Identification](https://www.kaggle.com/c/birdclef-2021/overview).

If you want to reproduce our results, please check `share_solution/working` directory.

## Overview

<img src="https://user-images.githubusercontent.com/846237/120944198-2968dc00-c76e-11eb-9bb9-ec8e8d63ce53.png">

To overview our solution, please check here.

- [Simplified version immediately after the competition](https://www.kaggle.com/c/birdclef-2021/discussion/243304)
- [Detailed version](https://www.kaggle.com/c/birdclef-2021/discussion/243927)

To put it simply, our solution is composed of the three stage training.

### 1st stage

Building melspectrogram classifier (0:nocall, 1:somebird singing) from freefield1010 data. (hereinafter referred to as "nocall detector")

[freefield1010](https://academictorrents.com/details/d247b92fa7b606e0914367c0839365499dd20121)

### 2nd stage

Building melspectrogram multilabel(397dims) classifier to identify which birds are singing in a clip(7sec). Before building it, we make 2nd stage input labels weighted with call probablility.

- training: train_short_audio data
- validation: train_soundscapes data

### 3rd stage

Candidate extraction from 2nd stage output (five birds extracted per clip(7sec)).
The train_metadata & forward/backward frame information are added as features and then classification for each of candidates (0:unlikely 1:likely) is performed by lightgbm.

- training: train_short_audio data
- validation: train_soundscapes data

### **To reproduce the result, please follow the steps below.**

Make sure you put datasets shown below in the right directory. All of the ipynb files have been confirmed to work in the Kaggle notebook environment. (You can just imitate the same directory structure as Kaggle, like input, working.)

## 1. BUILD NOCALL DETECTOR

We use the nocall detector for the following two purposes.

- A. To modify 2nd stage input data labels. 
- B. To attach labels to 3rd stage input data. At this time, threshold is 0.5 (hard labeling).

Check the code below.

- `/code`
    - [./share_solution/working/build_nocall_detector.ipynb](./share_solution/working/build_nocall_detector.ipynb)
        - This notebook is based on the following notebook by yasufuminakama@Kaggle. Please vote for his notebook as well.
        - [Cassava / resnext50_32x4d starter (training)](https://www.kaggle.com/yasufuminakama/cassava-resnext50-32x4d-starter-training)
- `/input`
    - [freefield1010 data](https://www.kaggle.com/startjapan/ff1010bird-duration7)
- `/output`
    - Nocall detector models (Ⅰ) are outputted.

## 2. TRAIN CALL PROBABILITIES

In this stage, we train call probabilities for each birds with no call probability on th e 1st stage.

Check the code below.

- `/code`
    - [./share_solution/working/build_melspectrogram_multilabel_classifier.ipynb](./share_solution/working/build_melspectrogram_multilabel_classifier.ipynb)
- `/input`
    - 7sec clip melspectrogram images of `train_short_audio`
    - [generated by kkiller's notebook](https://www.kaggle.com/kneroma/birdclef-mels-computer-public)
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part1
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part2
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part3
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part4
    - [BirdCLEF2020 data](https://www.kaggle.com/kami634/birdclef2020-validation-audio-and-ground-truth-d5)
    - [freefield1010](https://www.kaggle.com/startjapan/ff1010bird-duration7-1)
    - [nocall detector output for train_short_audio (See Appendix 2.)](https://www.kaggle.com/startjapan/train-short-audio-nocall-fold0to4)
    - [sklearn library (To use StratifiedGroupKfold, we have to install scikit-learn 1.0.dev0)](https://www.kaggle.com/namakemono/scikit-learn-10dev0)
- `/output`
    - melspectrogram multilabel classifier models (Ⅱ) are outputted.

## 3. EXTRACT CANDIDATES & ADD FEATURES & TRAIN LIGHTGBM & FIND A BEST THRESHOLD & MAKE SUBMISSION

Check the code below.

- `/code`
    - [./share_solution/working/third_stage.ipynb](./share_solution/working/third_stage.ipynb)
- `/input`
    - birdclef-2021 (original data)
    - [melspectrogram multilabel classifier models (Ⅱ)](https://www.kaggle.com/namakemono/birdclef-groupby-author-05221040-728258)
    - [modelf for BirdCLEF 2021](https://www.kaggle.com/kami634/clefmodel)
        - train_short_audio 397dims birdcall probabilities calculated by melspectrogram 
    - [multilabel classifier models (Ⅱ) (See Appendix 3.)](https://www.kaggle.com/namakemono/metadata-probability-v0525-2100)
    - [resnest library](https://www.kaggle.com/ttahara/resnest50-fast-package)
    - [sklearn library (To use StratifiedGroupKfold, we have to install scikit-learn 1.0.dev0)](https://www.kaggle.com/namakemono/scikit-learn-10dev0)
- `output`
    - submission.csv

## (Appendix 1) TRAIN_SHORT_AUDIO → MELSPECTROGRAM IMAGES

Here is a useful code by kneroma@Kaggle (maybe known as kkiller) to perform that.

(https://www.kaggle.com/kneroma/birdclef-mels-computer-public)

## (Appendix 2) TRAIN_SHORT_AUDIO (images) → NOCALL PROBABILITIES

- `/code`
    - [share_solution/working/nocalldetect_for_train_short_audio.ipynb](./share_solution/working/nocalldetect_for_train_short_audio.ipynb)
- `/input`
    - birdclef-2021 (original data)
    - 7sec clip melspectrogram images of `train_short_audio`
    - [generated by kkiller's notebook](https://www.kaggle.com/kneroma/birdclef-mels-computer-public)
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part1
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part2
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part3
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part4

nocall detector models (Ⅰ)

- `/output`
    - inference results for train_short_audio are outputted.

## (Appendix 3) TRAIN_SHORT_AUDIO (images) → 397dims birdcall probabilities

Check the code below.

- `/code`
    - [./share_solution/working/calculate_397dimprobs_for_train_short_audio.ipynb](./share_solution/working/calculate_397dimprobs_for_train_short_audio.ipynb)
- `/input`
    - birdclef-2021 (original data)
    - melspectrogram multilabel classifier models (Ⅰ)
    - 7sec clip melspectrogram images of train_short_audio
    - [generated by kkiller's notebook](https://www.kaggle.com/kneroma/birdclef-mels-computer-public)
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part1
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part2
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part3
        - https://www.kaggle.com/kneroma/kkiller-birdclef-mels-computer-d7-part4
    - [nocall detector output for train_short_audio](https://www.kaggle.com/startjapan/train-short-audio-nocall-fold0to4)
    - [sklearn library (To use StratifiedGroupKfold, we have to install scikit-learn 1.0.dev0)](https://www.kaggle.com/namakemono/scikit-learn-10dev0)
- `/output`
    - 397dims birdcall probabilities for train_short_audio (with some more features)

<hr>

## The hardware we used:

- kaggle notebook

- Google Colab Pro

- Personally-owned PC
    - OS : Ubuntu 18.04.3 LTS
    - CPU : Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz
    - Graphics : GeForce RTX 2080 Ti
    - Memory : 64GB

## Environment we used:

Check the Dockerfile below. This is the same as kaggle notebook environment on 2021/6/13.

[gpu.Dockerfile](./gpu.Dockerfile)